---
import "../styles/global.css";
import SiteHeader from "../components/site-header.astro";
import ClubCard from "../components/club-card.astro";
import { getClubs, getSearchIndex } from "../lib/clubs";
import SiteFooter from "../components/site-footer.astro";

const clubs = await getClubs();
const searchIndex = await getSearchIndex();
const searchBySlug = new Map(searchIndex.map((i) => [i.slug, i.text]));
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GVHS Clubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/public/icon.svg" />
  </head>

  <body class="min-h-screen bg-gray-50 text-gray-900">
    <!-- Header -->
    <SiteHeader title="GVHS Clubs" />

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-4 py-8">
      <!-- Search -->
      <div class="mb-6">
        <label for="club-search" class="sr-only">Search clubs</label>
        <input
          id="club-search"
          type="search"
          placeholder="Search by name, category, or description..."
          class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-400"
        />
      </div>

      <!-- Cards -->
      <div
        id="club-grid"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6"
      >
        {
          clubs.map((c) => (
            <div
              class="group/card"
              data-slug={c.slug}
              data-search={searchBySlug.get(c.slug) ?? ""}
            >
              <ClubCard
                href={`${import.meta.env.BASE_URL}/clubs/${c.slug}`}
                title={c.name}
                short={c.short}
                coverSrc={c.coverUrl}
                categories={c.categories}
              />
            </div>
          ))
        }
      </div>
    </main>

    <!-- Footer -->

    <SiteFooter />

    <!-- Client-side filter -->
    <script is:inline>
      (() => {
        const input = document.getElementById("club-search");
        const grid = document.getElementById("club-grid");
        if (!input || !grid) return;

        const items = Array.from(grid.querySelectorAll("[data-search]"));

        function applyFilter(q) {
          const query = (q || "").trim().toLowerCase();
          items.forEach((el) => {
            const hay = el.getAttribute("data-search") || "";
            const show = query === "" || hay.includes(query);
            el.style.display = show ? "" : "none";
          });
        }

        input.addEventListener("input", (e) => applyFilter(e.target.value));
      })();
    </script>
  </body>
</html>
